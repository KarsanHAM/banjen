apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'
apply plugin: 'io.fabric'

apply from: '../jacoco.gradle'

def appId = "com.makingiants.android.banjotuner"
def appVersionName = "1.5.6"
def appVersionCode = 115


android {
  compileSdkVersion setup.targetSdk
  flavorDimensions "default"

  defaultConfig {
    applicationId appId
    minSdkVersion setup.minSdk
    targetSdkVersion setup.targetSdk
    versionCode appVersionCode
    versionName appVersionName

    testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"

    // Enable just English configs for dependencies, allowing to shrink apk size more
    resConfigs "en", "pt"

    resValue "string", "ads_unit_id_banner", "${System.getenv("BANJEN_ADS_UNIT_ID_BANNER")}"
    resValue "string", "ads_app_id", "\"${System.getenv("BANJEN_ADMOB_APP_ID")}\""
  }

  buildTypes {
    debug {
      minifyEnabled false
      useProguard false // For performance
      testCoverageEnabled = true

      proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
    }
    release {
      minifyEnabled true
      shrinkResources true
      useProguard true

      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
    }
  }

  packagingOptions {
    exclude 'META-INF/services/org.xmlpull.v1.XmlPullParserFactory'
  }

  signingConfigs {
    release {
      if (project.hasProperty('BANJEN_SIGN_PATH')) {
        storeFile file(project.property("BANJEN_SIGN_PATH"))
        storePassword project.property("BANJEN_SIGN_PWD")
        keyAlias project.property("BANJEN_SIGN_ALIAS")
        keyPassword project.property("BANJEN_SIGN_PWD")
      }
    }
  }

  lintOptions {
    abortOnError false
  }


  // Build an instant app zip of our single APK. This saves having to create a feature module, an
  // instant app module, and a traditional application module just to get an aab and instant zip.
  applicationVariants.all { variant ->
    variant.outputs.all { output ->
      if (output.outputFile.name.endsWith('.apk')) {
        def zipInstant = tasks.create("zipInstant${variant.name.capitalize()}", Zip) {
          from(output.outputFile)
          archiveName = "instant-${output.name}.zip"
          destinationDir = output.outputFile.parentFile
        }
        zipInstant.dependsOn(output.assemble)
        tasks.getByName('assemble').dependsOn(zipInstant)
      }
    }
  }

}

def excludeAnnotations = {
  exclude group: 'com.android.support', module: 'support-annotations'
}

dependencies {
  implementation "com.android.support:appcompat-v7:${deps.supportLib}"
  implementation "org.jetbrains.kotlin:kotlin-stdlib:$deps.kotlin"

  implementation "com.google.firebase:firebase-core:16.0.4", {
    exclude group: 'com.android.support'
  }
  implementation "com.google.firebase:firebase-ads-lite:17.1.0", {
    exclude group: 'com.android.support'
    exclude group: 'com.google.android.gms', module: 'play-services'
    exclude group: 'com.google.android.gms', module: 'play-services-measurement-api'
    exclude group: 'com.google.android.gms', module: 'play-services-measurement-base'
  }

  implementation 'com.crashlytics.sdk.android:crashlytics:2.9.6'

  testImplementation 'junit:junit:4.12'
  testImplementation "org.jetbrains.kotlin:kotlin-stdlib:$deps.kotlin"
  testImplementation "org.jetbrains.kotlin:kotlin-test-junit:$deps.kotlin"

  androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2', excludeAnnotations
  androidTestImplementation 'com.android.support.test:runner:1.0.2', excludeAnnotations
  androidTestImplementation 'com.android.support.test:rules:1.0.2', excludeAnnotations
}

apply plugin: 'com.google.gms.google-services'